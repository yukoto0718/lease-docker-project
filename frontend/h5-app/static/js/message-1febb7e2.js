import{d as A,u as ee,k as te,r as I,y as oe,l as ne,o as ae,z as i,A as se,C as re,E as le,x as E,f as d,b as r,w as _,W as ce,a as u,e as s,F as z,g as N,G as ie,t as x,h as de,I as ue,L as fe,H as pe}from"./index-b744bed0.js";import{E as ve}from"./index-479e4c76.js";import"./index-ede2df1d.js";import{S as ge}from"./index-4f7c4551.js";/* empty css              */import{P as he}from"./PullDownRefreshContainer-eb4714b8.js";import{f as me}from"./date-ac2012ba.js";import{g as P}from"./auth-22cde164.js";import{S as _e}from"./index-3959dc36.js";import{I as we}from"./index-beccc506.js";import"./index-ae057aef.js";const ye={class:"main-container flex justify-around items-center bg-[--van-primary-background-color] h-[20vh] backdrop-filter backdrop-blur-xl backdrop-saturate-150"},ke=["onClick"],Ie={class:"mt-[2px]"},xe={class:"flex flex-col main-container"},be={class:"px-[15px] py-[10px]"},Se={key:0,class:"flex justify-center py-[20px]"},Ue={key:1,class:"flex flex-col items-center justify-center py-[30px]"},Ce={key:2},Te=["onClick"],Le={class:"flex items-center justify-center w-full h-full bg-gray-200 rounded-full"},Me={class:"flex flex-col justify-center ml-[10px] text-[14px] w-[70vw]"},Re={class:"flex justify-between mb-[3px]"},je={class:"font-bold"},$e={class:"text-[12px] text-gray-500"},De={class:"text-gray-600 van-ellipsis"},Ee=A({name:"Message"}),Je=A({...Ee,setup(ze){ee();const b=te(),W="https://fastly.jsdelivr.net/npm/@vant/assets/cat.jpeg",c=I([]),T=I(!1),f=I(""),p=I(),a=P(),w=oe();let S=null,U=null;const V=I([{icon:"volume-o",name:"createPost",path:"/post/create",color:"#f1be4a",badge:null},{icon:"wechat-moments",name:"userSpace",path:"",color:"#51b290",badge:null},{icon:"friends-o",name:"followList",path:"/follow",color:"#f39653",badge:null}]);function B(){const e=P();return(e==null?void 0:e.userId)||null}const C=()=>{var e;if(a!=null&&a.userId)return console.log("【调试】从auth.ts获取到用户ID:",a.userId),a.userId;try{const t=localStorage.getItem("token")||sessionStorage.getItem("token");if(t){const h=t.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),k=decodeURIComponent(atob(h).split("").map(m=>"%"+("00"+m.charCodeAt(0).toString(16)).slice(-2)).join("")),l=JSON.parse(k);if(l&&l.userId)return console.log("【调试】从token解析出用户ID:",l.userId),l.userId}}catch(t){console.error("解析token失败:",t)}try{const t=localStorage.getItem("app-user");if(t){const o=JSON.parse(t);if(o.userId)return console.log("【调试】从localStorage获取到userId:",o.userId),o.userId;if((e=o.userInfo)!=null&&e.userId)return console.log("【调试】从localStorage的userInfo获取到userId:",o.userInfo.userId),o.userInfo.userId}}catch(t){console.error("解析localStorage失败:",t)}return console.warn("【警告】无法获取有效的用户ID，WebSocket功能可能不正常"),null},G=e=>{if(e.name==="userSpace"){const t=B();t?b.push(`/blog/userSpace/${t}`):b.push("/login")}else e.path&&b.push(e.path)},L=()=>{if(i.getStatus()!==ce.OPEN){const t=C();t?i.connect(t):localStorage.getItem("token")&&i.connect(1)}},M=e=>{if(e.type==="chat"){const t=(a==null?void 0:a.userId)||C();console.log("【消息列表】收到聊天消息，当前用户:",t,"发送者:",e.senderId,"接收者:",e.receiverId),(e.receiverId===t||e.senderId===t)&&(console.log("【消息列表】收到相关聊天消息，刷新会话列表"),g(),e.totalUnreadCount!==void 0&&(console.log("【消息列表】从聊天消息更新总未读数:",e.totalUnreadCount),w.setTotalUnreadCount(e.totalUnreadCount)))}else e.type==="read"||e.type==="read_confirm"?(console.log("【消息列表】收到已读相关消息，刷新会话列表"),g(),e.totalUnreadCount!==void 0&&(console.log("【消息列表】从已读消息更新总未读数:",e.totalUnreadCount),w.setTotalUnreadCount(e.totalUnreadCount))):e.type==="pong"&&e.totalUnreadCount!==void 0&&(console.log("【消息列表】从心跳消息更新总未读数:",e.totalUnreadCount),w.setTotalUnreadCount(e.totalUnreadCount))},F=()=>{window.addEventListener("talk-new-message",e=>{R(e)}),window.addEventListener("talk-read-message",e=>{j()})},H=()=>{window.removeEventListener("talk-new-message",R),window.removeEventListener("talk-read-message",j)},R=e=>{const t=e.detail,o=(a==null?void 0:a.userId)||C();(t.receiverId===o||t.senderId===o)&&g()},j=e=>{g()};let v=null;const g=()=>{v&&clearTimeout(v),v=window.setTimeout(async()=>{console.log("【消息列表】刷新会话列表和未读计数");try{await y({current:1,size:20,keyword:f.value}),await w.updateTotalUnreadCount(),console.log("【消息列表】会话列表和未读计数刷新完成")}catch(e){console.error("【消息列表】刷新数据失败:",e)}v=null},300)};ne(()=>{console.log("【消息列表】组件被激活，刷新数据"),g(),L()});const O=async()=>{try{await y({current:1,size:20,keyword:f.value}),await w.updateTotalUnreadCount()}catch{E("获取消息列表失败，请稍后再试")}};ae(()=>{F(),window.addEventListener("talk-session-refresh",$);const e=C();e?(i.connect(e),i.addMessageHandler(M)):localStorage.getItem("token")&&(i.connect(1),i.addMessageHandler(M)),S=window.setInterval(()=>{L()},3e4),q(),O()}),se(()=>{H(),window.removeEventListener("talk-session-refresh",$),S&&(clearInterval(S),S=null),D();try{i.removeMessageHandler(M)}catch{}v&&(clearTimeout(v),v=null)});const $=()=>{console.log("【消息列表】收到会话刷新事件"),g()},q=()=>{D(),U=window.setInterval(()=>{y({current:1,size:20,keyword:f.value})},5e7)},D=()=>{U&&(clearInterval(U),U=null)};re(()=>document.visibilityState,e=>{e==="visible"&&(g(),L())});const y=async e=>{T.value=e.current===1;try{const t={...e,keyword:f.value,_t:Date.now()};console.log("【消息列表】加载会话列表，参数:",t);const o=await le(t);if(o.code===200&&o.data){let h=o.data.records||[];if(console.log("【消息列表】获取到会话数:",h.length),e.current===1)c.value=h;else{const k=new Set(c.value.map(m=>m.targetUserId)),l=h.filter(m=>!k.has(m.targetUserId));c.value=[...c.value,...l]}return p.value&&typeof p.value.setFinished=="function"&&p.value.setFinished(c.value.length>=(o.data.total||0)),!0}else return console.warn("【消息列表】API返回错误:",o),c.value=[],!1}catch(t){return console.error("【消息列表】加载失败:",t),E("加载失败，请重试"),!1}finally{T.value=!1}},J=()=>{p.value&&typeof p.value.onRefresh=="function"?p.value.onRefresh():y({current:1,size:20,keyword:f.value})},K=e=>{try{b.push({path:`/chat/${e.targetUserId}`,query:{nickname:e.targetNickname||"",avatar:e.targetAvatar||""}})}catch{window.location.href=`/chat/${e.targetUserId}?nickname=${encodeURIComponent(e.targetNickname||"")}&avatar=${encodeURIComponent(e.targetAvatar||"")}`}},Q=e=>e?me(new Date(e)):"";return(e,t)=>{const o=ue,h=_e,k=ge,l=fe,m=ve,X=we,Y=pe;return u(),d("div",null,[r(he,{request:y,ref_key:"pullDownRefreshContainerRef",ref:p,class:"min-h-[70vh]"},{default:_(()=>[r(h,{"offset-top":"0"},{default:_(()=>[s("div",ye,[(u(!0),d(z,null,N(V.value,n=>(u(),d("div",{key:n.path,class:"flex flex-col justify-center items-center",onClick:Z=>G(n)},[s("div",{style:ie({background:n.color}),class:"flex flex-col justify-center items-center h-[12vw] w-[12vw] rounded-xl py-[3px]"},[r(o,{name:n.icon,badge:n.badge,size:"25"},null,8,["name","badge"])],4),s("span",Ie,x(e.$t("router."+n.name)),1)],8,ke))),128))])]),_:1}),s("div",xe,[s("div",be,[r(k,{modelValue:f.value,"onUpdate:modelValue":t[0]||(t[0]=n=>f.value=n),placeholder:e.$t("follow.searchUser"),onSearch:J,shape:"round"},null,8,["modelValue","placeholder"])]),T.value?(u(),d("div",Se,[r(l,{size:"24px",vertical:""},{default:_(()=>[de(x(e.$t("common.loading")),1)]),_:1})])):c.value.length===0?(u(),d("div",Ue,[r(m,{description:e.$t("chat.noMessages")},null,8,["description"])])):(u(),d("div",Ce,[(u(!0),d(z,null,N(c.value,n=>(u(),d("div",{class:"flex py-[12px] px-[15px] active:bg-gray-100",key:n.id,onClick:Z=>K(n)},[r(Y,{content:n.unreadCount||"",max:"99"},{default:_(()=>[r(X,{round:"",width:"15vw",height:"15vw",src:n.targetAvatar||W,"error-icon":"photo-fail"},{error:_(()=>[s("div",Le,[r(o,{name:"contact",size:"25",color:"#999"})])]),loading:_(()=>[r(l,{type:"spinner",size:"20"})]),_:2},1032,["src"])]),_:2},1032,["content"]),s("div",Me,[s("div",Re,[s("div",je,x(n.targetNickname||`User${n.targetUserId}`),1),s("div",$e,x(Q(n.lastTime)),1)]),s("div",De,x(n.lastMessage||"暂无消息"),1)])],8,Te))),128))]))])]),_:1},512)])}}});export{Je as default};
