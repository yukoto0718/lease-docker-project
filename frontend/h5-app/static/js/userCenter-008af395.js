import{d as F,u as R,k as M,r as _,J as O,o as j,C as x,f as g,e as c,b as s,w as m,m as q,s as u,h as f,t as d,F as z,g as H,x as l,K as b,p as $,M as A,I as G,B as K,N as W,a as h,_ as Q}from"./index-b744bed0.js";import{F as X}from"./index-ede2df1d.js";import{U as Y}from"./index-c65fce34.js";import{_ as Z}from"./index-e727719b.js";import{d as C}from"./favicon-b4446a02.js";import{I as ee}from"./index-beccc506.js";import{s as te}from"./function-call-69531997.js";import"./index-515de819.js";const ne={class:"user-container"},ae={class:"user h-[25vh] flex flex-col justify-center items-center"},oe={class:"flex flex-col items-center"},re={class:"mt-[8px] font-bold text-[16px] flex items-center"},se={class:"main-container grid grid-cols-3 gap-y-8 px-4 mt-[30px]"},le=["onClick"],ie={class:"mt-1 text-sm"},ce={class:"main-container flex justify-center mt-[20px]"},ue={class:"p-4"},me={class:"flex flex-col items-center mb-4"},de=F({name:"UserCenter"}),pe=F({...de,setup(fe){const{t:o}=R(),y=M(),S=_([{icon:"历史",name:"router.browsingHistory",path:"/browsingHistory"},{icon:"预约",name:"router.myAppointments",path:"/myAppointment"},{icon:"合同",name:"router.myLeases",path:"/myAgreement"},{icon:"物业费用出账",name:"userCenter.payRent",path:""},{icon:"电费",name:"userCenter.payElectricity",path:""},{icon:"水费",name:"userCenter.payWater",path:""},{icon:"物业报修",name:"userCenter.maintenance",path:""}]),p=_(!1),a=_({nickname:"",avatarUrl:""}),k=()=>{var e,t;a.value.nickname=((e=n.userInfo)==null?void 0:e.nickname)||"",a.value.avatarUrl=((t=n.userInfo)==null?void 0:t.avatarUrl)||""},L=e=>e&&e.length<=20,N=async e=>{b({message:o("userCenter.uploading"),forbidClick:!0,duration:0});try{const t=new FormData;t.append("file",e.file);const i=await $.post("/app/file/upload",t,{headers:{"Content-Type":"multipart/form-data"}});i.code===200&&i.data?(a.value.avatarUrl=i.data,l(o("userCenter.uploadSuccess"))):(console.error("上传失败, API返回:",i),l(o("userCenter.uploadFailed")+": "+(i.message||"未知错误")))}catch(t){console.error("上传头像失败:",t),l(o("userCenter.uploadError"))}finally{A()}},T=async()=>{if(!a.value.nickname){l(o("userCenter.nicknameRequired"));return}if(a.value.nickname.length>20){l(o("userCenter.nicknameTooLong"));return}b({message:o("userCenter.saving"),forbidClick:!0,duration:0});try{const e=await $.post("/app/user/info",{nickname:a.value.nickname,avatarUrl:a.value.avatarUrl});e.code===200?(l(o("userCenter.updateSuccess")),await n.GetInfoAction(),n.userInfo||(n.userInfo={}),n.userInfo.nickname=a.value.nickname,a.value.avatarUrl&&(n.userInfo.avatarUrl=a.value.avatarUrl)):(console.error("更新失败, API返回:",e),e.code===201?l(o("userCenter.nicknameTooLong")):l(o("userCenter.updateFailed")+": "+(e.translatedMessage||e.message||"未知错误")))}catch(e){console.error("更新用户信息失败:",e),l(o("userCenter.updateError"))}finally{A()}},n=O(),V=()=>{n.Logout(),y.replace("/")};return j(async()=>{console.log("组件挂载前的用户信息:",JSON.stringify(n.userInfo)),await n.GetInfoAction(),console.log("组件挂载后的用户信息:",JSON.stringify(n.userInfo)),k()}),x(p,e=>{e&&k()}),x(()=>n.userInfo,(e,t)=>{console.log("用户信息发生变化:"),console.log("旧值:",JSON.stringify(t)),console.log("新值:",JSON.stringify(e))},{deep:!0}),(e,t)=>{var I,U;const i=ee,B=G,D=Z,w=K,E=Y,J=X,P=W;return h(),g("div",ne,[c("div",ae,[c("div",oe,[s(i,{onClick:t[0]||(t[0]=q(r=>{var v;return u(te)([((v=u(n).userInfo)==null?void 0:v.avatarUrl)||u(C)])},["stop"])),round:"",width:"30vw",height:"30vw",src:((I=u(n).userInfo)==null?void 0:I.avatarUrl)||u(C)},{error:m(()=>[f(d(e.$t("common.loadFailed")),1)]),_:1},8,["src"]),c("div",re,[f(d(((U=u(n).userInfo)==null?void 0:U.nickname)||e.$t("userCenter.unknownUser"))+" ",1),s(B,{name:"edit",class:"ml-1 text-gray-500",onClick:t[1]||(t[1]=r=>p.value=!0)})])])]),c("div",se,[(h(!0),g(z,null,H(S.value,r=>(h(),g("div",{key:r.path,class:"flex flex-col justify-center items-center",onClick:v=>u(y).push(r.path)},[s(D,{name:r.icon,size:"50"},null,8,["name"]),c("span",ie,d(e.$t(r.name)),1)],8,le))),128))]),c("div",ce,[s(w,{type:"primary",class:"w-[90vw] h-[50px] rounded-lg",onClick:V},{default:m(()=>[f(d(e.$t("userCenter.logout")),1)]),_:1})]),s(P,{show:p.value,"onUpdate:show":t[3]||(t[3]=r=>p.value=r),title:e.$t("userCenter.editProfile"),"show-cancel-button":"","confirm-button-text":e.$t("common.confirm"),"cancel-button-text":e.$t("common.cancel"),onConfirm:T},{default:m(()=>[c("div",ue,[c("div",me,[s(i,{round:"",width:"80",height:"80",src:a.value.avatarUrl||u(C),class:"mb-2"},null,8,["src"]),s(E,{"after-read":N,"max-count":1,"preview-size":80,"preview-image":!1,"upload-text":e.$t("userCenter.uploadAvatar"),class:"mt-2"},{default:m(()=>[s(w,{type:"primary",size:"small"},{default:m(()=>[f(d(e.$t("userCenter.uploadAvatar")),1)]),_:1})]),_:1},8,["upload-text"])]),s(J,{modelValue:a.value.nickname,"onUpdate:modelValue":t[2]||(t[2]=r=>a.value.nickname=r),label:e.$t("userCenter.nickname"),placeholder:e.$t("userCenter.nicknamePlaceholder"),rules:[{required:!0,message:e.$t("userCenter.nicknameRequired")},{validator:L,message:e.$t("userCenter.nicknameTooLong")}],maxlength:"20","show-word-limit":""},null,8,["modelValue","label","placeholder","rules"])])]),_:1},8,["show","title","confirm-button-text","cancel-button-text"])])}}});const Ie=Q(pe,[["__scopeId","data-v-5ad75424"]]);export{Ie as default};
