import{Z as Q,ax as T,ay as W,d as E,aa as Y,ad as ee,b as r,I as F,L as ae,az as M,ac as le,aA as ne,U as C,a4 as D,a8 as P,a9 as U,V as te,r as x,A as re,a1 as ie,aB as oe,ak as se,v as B,aq as O,aC as ce,a2 as R,T as ue,au as de,a3 as fe}from"./index-b744bed0.js";import{s as ve}from"./function-call-69531997.js";import{I as ge}from"./index-beccc506.js";const[me,i,we]=Q("uploader");function N(e,n){return new Promise(o=>{if(n==="file"){o();return}const c=new FileReader;c.onload=v=>{o(v.target.result)},n==="dataUrl"?c.readAsDataURL(e):n==="text"&&c.readAsText(e)})}function _(e,n){return T(e).some(o=>o.file?W(n)?n(o.file):o.file.size>+n:!1)}function pe(e,n){const o=[],c=[];return e.forEach(v=>{_(v,n)?c.push(v):o.push(v)}),{valid:o,invalid:c}}const be=/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg|avif)/i,he=e=>be.test(e);function q(e){return e.isImage?!0:e.file&&e.file.type?e.file.type.indexOf("image")===0:e.url?he(e.url):typeof e.content=="string"?e.content.indexOf("data:image")===0:!1}var ye=E({props:{name:Y,item:ee(Object),index:Number,imageFit:String,lazyLoad:Boolean,deletable:Boolean,reupload:Boolean,previewSize:[Number,String,Array],beforeDelete:Function},emits:["delete","preview","reupload"],setup(e,{emit:n,slots:o}){const c=()=>{const{status:t,message:f}=e.item;if(t==="uploading"||t==="failed"){const g=t==="failed"?r(F,{name:"close",class:i("mask-icon")},null):r(ae,{class:i("loading")},null),d=le(f)&&f!=="";return r("div",{class:i("mask")},[g,d&&r("div",{class:i("mask-message")},[f])])}},v=t=>{const{name:f,item:g,index:d,beforeDelete:k}=e;t.stopPropagation(),ne(k,{args:[g,{name:f,index:d}],done:()=>n("delete")})},m=()=>n("preview"),y=()=>n("reupload"),w=()=>{if(e.deletable&&e.item.status!=="uploading"){const t=o["preview-delete"];return r("div",{role:"button",class:i("preview-delete",{shadow:!t}),tabindex:0,"aria-label":we("delete"),onClick:v},[t?t():r(F,{name:"cross",class:i("preview-delete-icon")},null)])}},h=()=>{if(o["preview-cover"]){const{index:t,item:f}=e;return r("div",{class:i("preview-cover")},[o["preview-cover"](C({index:t},f))])}},I=()=>{const{item:t,lazyLoad:f,imageFit:g,previewSize:d,reupload:k}=e;return q(t)?r(ge,{fit:g,src:t.objectUrl||t.content||t.url,class:i("preview-image"),width:Array.isArray(d)?d[0]:d,height:Array.isArray(d)?d[1]:d,lazyLoad:f,onClick:k?y:m},{default:h}):r("div",{class:i("file"),style:M(e.previewSize)},[r(F,{class:i("file-icon"),name:"description"},null),r("div",{class:[i("file-name"),"van-ellipsis"]},[t.file?t.file.name:t.url]),h()])};return()=>r("div",{class:i("preview")},[I(),c(),w()])}});const ke={name:D(""),accept:P("image/*"),capture:String,multiple:Boolean,disabled:Boolean,readonly:Boolean,lazyLoad:Boolean,maxCount:D(1/0),imageFit:P("cover"),resultType:P("dataUrl"),uploadIcon:P("photograph"),uploadText:String,deletable:U,reupload:Boolean,afterRead:Function,showUpload:U,modelValue:te(),beforeRead:Function,beforeDelete:Function,previewSize:[Number,String,Array],previewImage:U,previewOptions:Object,previewFullImage:U,maxSize:{type:[Number,String,Function],default:1/0}};var Ie=E({name:me,props:ke,emits:["delete","oversize","clickUpload","closePreview","clickPreview","clickReupload","update:modelValue"],setup(e,{emit:n,slots:o}){const c=x(),v=[],m=x(-1),y=x(!1),w=(a=e.modelValue.length)=>({name:e.name,index:a}),h=()=>{c.value&&(c.value.value="")},I=a=>{if(h(),_(a,e.maxSize))if(Array.isArray(a)){const l=pe(a,e.maxSize);if(a=l.valid,n("oversize",l.invalid,w()),!a.length)return}else{n("oversize",a,w());return}if(a=de(a),m.value>-1){const l=[...e.modelValue];l.splice(m.value,1,a),n("update:modelValue",l),m.value=-1}else n("update:modelValue",[...e.modelValue,...T(a)]);e.afterRead&&e.afterRead(a,w())},t=a=>{const{maxCount:l,modelValue:u,resultType:s}=e;if(Array.isArray(a)){const p=+l-u.length;a.length>p&&(a=a.slice(0,p)),Promise.all(a.map(b=>N(b,s))).then(b=>{const K=a.map((S,V)=>{const j={file:S,status:"",message:"",objectUrl:URL.createObjectURL(S)};return b[V]&&(j.content=b[V]),j});I(K)})}else N(a,s).then(p=>{const b={file:a,status:"",message:"",objectUrl:URL.createObjectURL(a)};p&&(b.content=p),I(b)})},f=a=>{const{files:l}=a.target;if(e.disabled||!l||!l.length)return;const u=l.length===1?l[0]:[].slice.call(l);if(e.beforeRead){const s=e.beforeRead(u,w());if(!s){h();return}if(ce(s)){s.then(p=>{t(p||u)}).catch(h);return}}t(u)};let g;const d=()=>n("closePreview"),k=a=>{if(e.previewFullImage){const l=e.modelValue.filter(q),u=l.map(s=>(s.objectUrl&&!s.url&&s.status!=="failed"&&(s.url=s.objectUrl,v.push(s.url)),s.url)).filter(Boolean);g=ve(C({images:u,startPosition:l.indexOf(a),onClose:d},e.previewOptions))}},G=()=>{g&&g.close()},X=(a,l)=>{const u=e.modelValue.slice(0);u.splice(l,1),n("update:modelValue",u),n("delete",a,w(l))},z=a=>{y.value=!0,m.value=a,se(()=>L())},Z=()=>{y.value||(m.value=-1),y.value=!1},$=(a,l)=>{const u=["imageFit","deletable","reupload","previewSize","beforeDelete"],s=C(R(e,u),R(a,u,!0));return r(ye,ue({item:a,index:l,onClick:()=>n(e.reupload?"clickReupload":"clickPreview",a,w(l)),onDelete:()=>X(a,l),onPreview:()=>k(a),onReupload:()=>z(l)},R(e,["name","lazyLoad"]),s),R(o,["preview-cover","preview-delete"]))},H=()=>{if(e.previewImage)return e.modelValue.map($)},A=a=>n("clickUpload",a),J=()=>{const a=e.modelValue.length<+e.maxCount,l=e.readonly?null:r("input",{ref:c,type:"file",class:i("input"),accept:e.accept,capture:e.capture,multiple:e.multiple&&m.value===-1,disabled:e.disabled,onChange:f,onClick:Z},null);return o.default?B(r("div",{class:i("input-wrapper"),onClick:A},[o.default(),l]),[[O,a]]):B(r("div",{class:i("upload",{readonly:e.readonly}),style:M(e.previewSize),onClick:A},[r(F,{name:e.uploadIcon,class:i("upload-icon")},null),e.uploadText&&r("span",{class:i("upload-text")},[e.uploadText]),l]),[[O,e.showUpload&&a]])},L=()=>{c.value&&!e.disabled&&c.value.click()};return re(()=>{v.forEach(a=>URL.revokeObjectURL(a))}),ie({chooseFile:L,reuploadFile:z,closeImagePreview:G}),oe(()=>e.modelValue),()=>r("div",{class:i()},[r("div",{class:i("wrapper",{disabled:e.disabled})},[H(),J()])])}});const Fe=fe(Ie);export{Fe as U};
