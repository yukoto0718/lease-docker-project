import{Z as Ee,a4 as Pe,a8 as je,a9 as Oe,d as ce,r as f,aT as $e,P as le,C as ie,b7 as Ae,o as ke,a1 as Re,ag as De,b as v,ak as H,aG as ye,aW as Be,L as be,a3 as Le,u as Ve,O as Fe,k as We,J as ze,x as b,l as Je,z as h,A as Ge,b4 as He,b8 as qe,y as ne,W as P,b9 as Ke,f as B,w as x,s as Ze,e as y,ba as Qe,m as _e,B as Xe,av as Ye,a5 as et,a as j,h as re,t as S,j as ee,F as tt,g as at,n as oe,c as Se,I as st,_ as nt}from"./index-b744bed0.js";import{F as rt}from"./index-ede2df1d.js";import{P as ot}from"./index-ae057aef.js";import{E as lt}from"./index-479e4c76.js";import{f as it}from"./date-ac2012ba.js";import{g as we}from"./auth-22cde164.js";import{u as ct}from"./use-tab-status-e5f41a03.js";import{I as ut}from"./index-beccc506.js";const[dt,L,vt]=Ee("list"),ft={error:Boolean,offset:Pe(300),loading:Boolean,disabled:Boolean,finished:Boolean,scroller:Object,errorText:String,direction:je("down"),loadingText:String,finishedText:String,immediateCheck:Oe};var gt=ce({name:dt,props:ft,emits:["load","update:error","update:loading"],setup(i,{emit:m,slots:_}){const M=f(i.loading),V=f(),u=f(),l=ct(),q=$e(V),g=le(()=>i.scroller||q.value),T=()=>{H(()=>{if(M.value||i.finished||i.disabled||i.error||(l==null?void 0:l.value)===!1)return;const{direction:s}=i,p=+i.offset,C=ye(g);if(!C.height||Be(V))return;let D=!1;const d=ye(u);s==="up"?D=C.top-d.top<=p:D=d.bottom-C.bottom<=p,D&&(M.value=!0,m("update:loading",!0),m("load"))})},U=()=>{if(i.finished){const s=_.finished?_.finished():i.finishedText;if(s)return v("div",{class:L("finished-text")},[s])}},R=()=>{m("update:error",!1),T()},ue=()=>{if(i.error){const s=_.error?_.error():i.errorText;if(s)return v("div",{role:"button",class:L("error-text"),tabindex:0,onClick:R},[s])}},K=()=>{if(M.value&&!i.finished&&!i.disabled)return v("div",{class:L("loading")},[_.loading?_.loading():v(be,{class:L("loading-icon")},{default:()=>[i.loadingText||vt("loading")]})])};return ie(()=>[i.loading,i.finished,i.error],T),l&&ie(l,s=>{s&&T()}),Ae(()=>{M.value=i.loading}),ke(()=>{i.immediateCheck&&T()}),Re({check:T}),De("scroll",T,{target:g,passive:!0}),()=>{var s;const p=(s=_.default)==null?void 0:s.call(_),C=v("div",{ref:u,class:L("placeholder")},null);return v("div",{ref:V,role:"feed",class:L(),"aria-busy":M.value},[i.direction==="down"?p:C,K(),U(),ue(),i.direction==="up"?p:C])}}});const mt=Le(gt);const ht={class:"chat-container bg-[--color-block-background] min-h-screen"},pt={key:0,class:"flex justify-center py-8"},It={key:1,class:"flex justify-center py-[20px]"},yt={class:"flex items-center justify-center w-full h-full bg-gray-200 rounded-full"},_t={class:"flex items-center justify-center w-full h-full bg-gray-200 rounded-full"},St={class:"footer-input fixed bottom-0 left-0 right-0 bg-white p-[10px] flex items-center"},wt={class:"p-4"},kt={class:"text-lg font-bold mb-2"},bt={class:"mb-2"},xt={key:0,class:"text-sm overflow-auto",style:{"max-height":"200px"}},Ut=ce({name:"Chat"}),Mt=ce({...Ut,setup(i){var he,pe,Ie;const{t:m}=Ve();let _=null;const M=Fe(),V=We(),u=le(()=>{const e=M.params.userId,t=e?parseInt(e.toString()):null;return isNaN(t)?null:t}),l=ze(),q=localStorage.getItem("app-user");let g=null;if(q)try{g=JSON.parse(q)}catch(e){console.error("解析localStorage用户信息失败:",e)}const T=we(),U="https://fastly.jsdelivr.net/npm/@vant/assets/cat.jpeg";let R=null;if(l.userInfo&&typeof l.userInfo=="object"){const e=["userId","id","user_id","uid"];for(const t of e)if(l.userInfo[t]){R=l.userInfo[t];break}}if(!R&&g){const e=["userId","id","user_id","uid"];for(const t of e)if(g[t]){R=g[t];break}}(()=>{const t=new URLSearchParams(window.location.search).get("fromUserId");return t&&!isNaN(parseInt(t))?parseInt(t):null})();let K=R||(T?T.userId:null);K||b(m("chat.invalidUser"));const s=f({userId:K,nickname:((he=l.userInfo)==null?void 0:he.nickname)||(g==null?void 0:g.nickname)||"用户",avatar:((pe=l.userInfo)==null?void 0:pe.avatar)||((Ie=l.userInfo)==null?void 0:Ie.avatar_url)||(g==null?void 0:g.avatar)||(g==null?void 0:g.avatar_url)||U}),p=f(null),C=f(M.query.nickname||""),D=f(M.query.avatar||""),d=f([]),O=f(""),$=f(!1),A=f(!1),te=f(!1),F=f(1),W=f(new Set),Z=f(null),Q=f(!1),z=f(""),de=le(()=>{switch(h.getStatus()){case P.CONNECTING:return"连接中...";case P.OPEN:return"已连接";case P.CLOSING:return"关闭中...";case P.CLOSED:return"已关闭";default:return"未知"}}),ae=()=>{var t;if(h.getStatus()!==P.OPEN){const a=(t=s.value)==null?void 0:t.userId;if(!a||a<=0){if(!(localStorage.getItem("token")||sessionStorage.getItem("token")))return;b(m("chat.invalidUser"));return}h.connect(a)}},xe=()=>{var t;Q.value=!0;const e={type:"debug",senderId:(t=s.value)==null?void 0:t.userId,timestamp:Date.now()};try{h.sendMessage(e),z.value=JSON.stringify({currentUser:s.value,targetUser:p.value,wsStatus:de.value,messages:d.value.length,processedIds:Array.from(W.value).slice(-5)},null,2)}catch(a){z.value=`发送调试消息失败: ${a}`}};Je(()=>{u.value&&d.value.length>0&&X(),ae()}),ke(()=>{var e,t;if(s.value&&(!s.value.avatar||s.value.avatar.includes("/vant/assets/cat.jpeg"))){let a=null;if((e=l.userInfo)!=null&&e.avatar&&!l.userInfo.avatar.includes("/vant/assets/cat.jpeg"))a=l.userInfo.avatar;else if((t=l.userInfo)!=null&&t.avatar_url&&!l.userInfo.avatar_url.includes("/vant/assets/cat.jpeg"))a=l.userInfo.avatar_url;else try{const r=localStorage.getItem("app-user");if(r){const o=JSON.parse(r);o.avatar&&!o.avatar.includes("/vant/assets/cat.jpeg")?a=o.avatar:o.avatar_url&&!o.avatar_url.includes("/vant/assets/cat.jpeg")&&(a=o.avatar_url)}}catch(r){console.error("解析localStorage中的用户信息失败:",r)}a&&(s.value.avatar=a)}if((C.value||D.value)&&(p.value={targetNickname:C.value,targetAvatar:D.value}),!s.value||!s.value.userId){const a=we();a&&a.userId?s.value={userId:a.userId,nickname:a.nickname||"当前用户",avatar:a.avatar||U}:b(m("chat.invalidUser"))}try{const a=s.value.userId;if(!a||a<=0){if(!(localStorage.getItem("token")||sessionStorage.getItem("token"))){b(m("errors.app_login_auth"));return}b(m("chat.invalidUser"));return}h.connect(a),h.addMessageHandler(se),_=window.setInterval(()=>{ae()},6e4)}catch{b(m("chat.reconnecting"))}J(),u.value&&X(),window.addEventListener("talk-new-message",ge),window.addEventListener("talk-polling-update",me)}),Ge(()=>{_&&(clearInterval(_),_=null);try{h.removeMessageHandler(se)}catch{}window.removeEventListener("talk-new-message",ge),window.removeEventListener("talk-polling-update",me),ve()}),He(()=>{ve()});const ve=()=>{try{const e=new CustomEvent("talk-session-refresh",{bubbles:!0,cancelable:!0});window.dispatchEvent(e)}catch{}};ie(()=>u.value,e=>{e&&(d.value=[],W.value.clear(),F.value=1,A.value=!1,J(),X())});const Ue=async()=>{try{F.value++,await J(!0)}catch{$.value=!1}},Me=async()=>{try{F.value=1,A.value=!1,await J()}catch{}finally{te.value=!1}},X=async()=>{if(u.value)try{const e=await qe(u.value);if(e.code===200){typeof e.data=="number"&&ne().setTotalUnreadCount(e.data);try{const t={type:"read",targetUserId:u.value,timestamp:Date.now()};h.getStatus()===P.OPEN?h.sendMessage(t):(ae(),setTimeout(()=>{h.getStatus()===P.OPEN&&h.sendMessage(t)},2e3))}catch{}}}catch{}},J=async(e=!1)=>{if(u.value)try{$.value=!0;const t=await Ke(u.value,F.value,20);if(t.code===200&&t.data){const a=t.data;if(a&&a.length>0){const r=[...a].sort((o,I)=>new Date(o.createTime).getTime()-new Date(I.createTime).getTime());if(e){const o=new Set(d.value.map(w=>w.id)),I=r.filter(w=>!o.has(w.id));d.value=[...I,...d.value]}else d.value=r;if(a.forEach(o=>{W.value.add(o.id)}),a.length>0&&!p.value){const o=a.find(I=>!I.isSelf);o&&(p.value={targetNickname:o.senderNickname,targetAvatar:o.senderAvatar})}a.length<20&&(A.value=!0)}else A.value=!0;e||(await H(),Y())}else t.code!==401&&b(t.message||m("common.loadFailed")),A.value=!0}catch{A.value=!0}finally{$.value=!1}},se=e=>{var a,r,o,I,w;const t=(a=s.value)==null?void 0:a.userId;if(t)if(e.type==="chat"){if(e.senderId===u.value&&e.receiverId===t||e.receiverId===u.value&&e.senderId===t){if(e.senderId===t&&e.clientMsgId){const k=d.value.findIndex(c=>c.id===e.clientMsgId);if(k>=0){const c={...d.value[k]};c.id=e.messageId||c.id,e.timestamp&&(c.createTime=new Date(e.timestamp).toISOString()),d.value.splice(k,1,c);return}}const N={id:e.messageId||Date.now(),content:e.content||"",senderId:e.senderId||0,senderNickname:e.senderId===t?((r=s.value)==null?void 0:r.nickname)||`用户${e.senderId}`:((o=p.value)==null?void 0:o.targetNickname)||`用户${e.senderId}`,senderAvatar:e.senderId===t?((I=s.value)==null?void 0:I.avatar)||U:((w=p.value)==null?void 0:w.targetAvatar)||U,receiverId:e.receiverId||0,createTime:e.timestamp?new Date(e.timestamp).toISOString():new Date().toISOString(),isSelf:e.senderId===t};if(d.value.find(k=>k.id===N.id||e.messageId&&k.id===e.messageId))return;d.value.push(N),W.value.add(N.id),N.isSelf||X(),H(()=>{Y()})}}else e.type==="read_confirm"?e.totalUnreadCount!==void 0&&ne().setTotalUnreadCount(e.totalUnreadCount):e.type==="pong"?e.totalUnreadCount!==void 0&&ne().setTotalUnreadCount(e.totalUnreadCount):e.type==="debug_response"&&(z.value=JSON.stringify(e,null,2))},fe=async()=>{var w,E,N,G,k;if(!O.value.trim())return;if(!u.value){b(m("chat.invalidTarget"));return}const e=(w=s.value)==null?void 0:w.userId;if(!e||e<=0){b(m("chat.invalidUser"));return}const t=O.value.trim(),a=Date.now();let r=null;if((E=s.value)!=null&&E.avatar&&s.value.avatar!==U&&!s.value.avatar.includes("/vant/assets/cat.jpeg"))r=s.value.avatar;else if((N=l.userInfo)!=null&&N.avatar&&!l.userInfo.avatar.includes("/vant/assets/cat.jpeg"))r=l.userInfo.avatar;else if((G=l.userInfo)!=null&&G.avatar_url&&!l.userInfo.avatar_url.includes("/vant/assets/cat.jpeg"))r=l.userInfo.avatar_url;else try{const c=localStorage.getItem("app-user");if(c){const n=JSON.parse(c);n.avatar&&!n.avatar.includes("/vant/assets/cat.jpeg")?r=n.avatar:n.avatar_url&&!n.avatar_url.includes("/vant/assets/cat.jpeg")&&(r=n.avatar_url)}}catch(c){console.error("解析localStorage中的用户信息失败:",c)}if(!r){const c=d.value.filter(n=>n.isSelf);if(c.length>0){const n=c[c.length-1];n.senderAvatar&&!n.senderAvatar.includes("/vant/assets/cat.jpeg")&&(r=n.senderAvatar)}}r||(r=U);const o={id:a,content:t,senderId:e,senderNickname:((k=s.value)==null?void 0:k.nickname)||"我",senderAvatar:r,receiverId:u.value,createTime:new Date().toISOString(),isSelf:!0};W.value.add(a),d.value.push(o),O.value="",H(()=>{Y()});const I={type:"chat",messageId:void 0,clientMsgId:a,senderId:e,receiverId:u.value,content:t,timestamp:Date.now()};try{const c=new CustomEvent("talk-new-message",{detail:I,bubbles:!0,cancelable:!0});window.dispatchEvent(c)}catch{}try{h.getStatus()===P.OPEN?h.sendMessage(I):(h.connect(e),setTimeout(()=>{h.sendMessage(I)},1e3),b(m("chat.reconnecting")))}catch{b(m("chat.sendFailed"))}},Y=()=>{Z.value&&(Z.value.scrollTop=Z.value.scrollHeight)},Te=e=>it(new Date(e)),ge=e=>{const t=e.detail;t.type==="chat"&&(t.senderId===u.value&&t.receiverId===s.value.userId||t.receiverId===u.value&&t.senderId===s.value.userId)&&se(t)},me=e=>{const{targetUserId:t,hasNewMessages:a}=e.detail;a&&t===u.value&&Ce()},Ce=async()=>{try{F.value=1,await J(),H(()=>{Y()})}catch{}};return(e,t)=>{const a=Xe,r=Ye,o=be,I=lt,w=st,E=ut,N=mt,G=ot,k=rt,c=et;return j(),B("div",ht,[v(r,{title:p.value?p.value.targetNickname||`${e.$t("community.user")}${u.value}`:e.$t("router.chat"),"left-arrow":"",onClickLeft:t[0]||(t[0]=n=>Ze(V).back())},{right:x(()=>[v(a,{size:"small",type:"primary",onClick:xe},{default:x(()=>[re(S(e.$t("chat.checkOnline")),1)]),_:1})]),_:1},8,["title"]),y("div",{ref_key:"messageContainerRef",ref:Z,class:"message-list px-[15px] pb-[80px] pt-[10px] overflow-y-auto"},[v(G,{modelValue:te.value,"onUpdate:modelValue":t[2]||(t[2]=n=>te.value=n),onRefresh:Me},{default:x(()=>[v(N,{loading:$.value,"onUpdate:loading":t[1]||(t[1]=n=>$.value=n),finished:A.value,"finished-text":"",onLoad:Ue,"immediate-check":!1},{default:x(()=>[d.value.length===0&&$.value?(j(),B("div",pt,[v(o,{color:"primary"})])):d.value.length===0&&!$.value?(j(),B("div",It,[v(I,{description:e.$t("chat.noMessages")},null,8,["description"])])):ee("",!0),(j(!0),B(tt,null,at(d.value,(n,Ne)=>(j(),B("div",{key:Ne,class:"mb-4"},[y("div",{class:oe(["flex",n.isSelf?"justify-end":"justify-start"])},[n.isSelf?ee("",!0):(j(),Se(E,{key:0,round:"",width:"40px",height:"40px",src:n.senderAvatar||U,class:"mr-2","error-icon":"photo-fail"},{error:x(()=>[y("div",yt,[v(w,{name:"contact",size:"20",color:"#999"})])]),loading:x(()=>[v(o,{type:"spinner",size:"20"})]),_:2},1032,["src"])),y("div",{class:oe(["max-w-[70%] p-3 rounded-lg",n.isSelf?"bg-[--van-primary-color] text-white":"bg-white text-[--van-text-color]"])},S(n.content),3),n.isSelf?(j(),Se(E,{key:1,round:"",width:"40px",height:"40px",src:n.senderAvatar||s.value.avatar||U,class:"ml-2","error-icon":"photo-fail"},{error:x(()=>[y("div",_t,[v(w,{name:"contact",size:"20",color:"#999"})])]),loading:x(()=>[v(o,{type:"spinner",size:"20"})]),_:2},1032,["src"])):ee("",!0)],2),y("div",{class:oe(["text-xs text-gray-400 mt-1",n.isSelf?"text-right":"text-left"])},S(Te(n.createTime)),3)]))),128))]),_:1},8,["loading","finished"])]),_:1},8,["modelValue"])],512),y("div",St,[v(k,{modelValue:O.value,"onUpdate:modelValue":t[3]||(t[3]=n=>O.value=n),placeholder:e.$t("chat.inputPlaceholder"),class:"flex-1",onKeyup:t[4]||(t[4]=Qe(_e(n=>O.value.trim()&&fe(),["prevent"]),["enter"]))},null,8,["modelValue","placeholder"]),v(a,{type:"primary",size:"small",class:"ml-[10px]",disabled:!O.value.trim(),onClick:t[5]||(t[5]=_e(n=>fe(),["prevent"]))},{default:x(()=>[re(S(e.$t("chat.send")),1)]),_:1},8,["disabled"])]),v(c,{show:Q.value,"onUpdate:show":t[7]||(t[7]=n=>Q.value=n),position:"bottom",style:{height:"40%"}},{default:x(()=>[y("div",wt,[y("h3",kt,S(e.$t("chat.debugInfo")),1),y("div",bt,[y("p",null,S(e.$t("chat.currentUserId"))+": "+S(s.value.userId),1),y("p",null,S(e.$t("chat.targetUserId"))+": "+S(u.value),1),y("p",null,S(e.$t("chat.webSocketStatus"))+": "+S(de.value),1)]),z.value?(j(),B("div",xt,[y("pre",null,S(z.value),1)])):ee("",!0),v(a,{block:"",type:"primary",onClick:t[6]||(t[6]=n=>Q.value=!1)},{default:x(()=>[re(S(e.$t("common.close")),1)]),_:1})])]),_:1},8,["show"])])}}});const At=nt(Mt,[["__scopeId","data-v-c9842ef2"]]);export{At as default};
